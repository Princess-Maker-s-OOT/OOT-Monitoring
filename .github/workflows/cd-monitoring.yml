name: CD Monitoring Stack

on:
  push:
    branches: [ "main" ]
    paths:
      - "docker-compose.yml"
      - "loki/**"
      - "grafana/**"
      - "promtail/**"
      - "scripts/**"

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ ì¶”ê°€
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. SSHë¡œ ëª¨ë‹ˆí„°ë§ ì„œë²„ ì ‘ì† ë° ë°°í¬
      - name: Deploy to Monitoring Server via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          command_timeout: 5m  # ë°°í¬ ì‘ì—…ì´ ê¸¸ ìˆ˜ ìˆìœ¼ë¯€ë¡œ timeout ì—°ì¥
          script: |
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

            echo "=========================================="
            echo "ğŸš€ Starting Monitoring Stack Deployment"
            echo "=========================================="

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì •
            PROJECT_DIR="/home/${{ secrets.SSH_USERNAME }}/OOT-Monitoring"

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "âŒ Error: Project directory not found: $PROJECT_DIR"
              echo ""
              echo "Please clone the repository first:"
              echo "  cd ~"
              echo "  git clone <repository-url> monitoring"
              exit 1
            fi

            cd "$PROJECT_DIR"
            echo "ğŸ“‚ Working directory: $(pwd)"

            # Git ì €ì¥ì†Œ ì—…ë°ì´íŠ¸
            echo ""
            echo "ğŸ“¥ Pulling latest changes from main branch..."
            git fetch origin
            git reset --hard origin/main  # ë¡œì»¬ ë³€ê²½ì‚¬í•­ ë¬´ì‹œí•˜ê³  ê°•ì œ ì—…ë°ì´íŠ¸

            # .env íŒŒì¼ í™•ì¸ (í•„ìˆ˜)
            if [ ! -f ".env" ]; then
              echo ""
              echo "âŒ Error: .env file not found in $PROJECT_DIR"
              echo ""
              echo "Please create .env file on EC2 server first:"
              echo "  cd $PROJECT_DIR"
              echo "  cat > .env << 'EOF'"
              echo "GRAFANA_ADMIN_USER=admin"
              echo "GRAFANA_ADMIN_PASSWORD=YourStrongPassword"
              echo "GRAFANA_PORT=3000"
              echo "EOF"
              echo ""
              exit 1
            else
              echo "âœ… .env file exists"
            fi

            # Docker ì„¤ì¹˜ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "âŒ Error: Docker is not installed!"
              echo "Please install Docker first."
              exit 1
            fi

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ í™•ì¸
            chmod +x scripts/deploy-monitoring.sh

            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo ""
            echo "ğŸ”§ Running deployment script..."
            bash scripts/deploy-monitoring.sh

            # ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
            echo ""
            echo "=========================================="
            echo "âœ… Deployment Completed Successfully!"
            echo "=========================================="
            echo ""
            echo "ğŸ“Š Grafana Dashboard: http://${{ secrets.SERVER_IP }}:3000"
            echo "   Default login: admin / admin"
            echo ""
            echo "ğŸ” Loki API: http://${{ secrets.SERVER_IP }}:3100"
            echo ""
            echo "ğŸ’¡ Useful commands:"
            echo "   Check status:  docker compose ps"
            echo "   View logs:     docker compose logs -f"
            echo "   Restart:       docker compose restart"
            echo "   Stop:          docker compose down"
